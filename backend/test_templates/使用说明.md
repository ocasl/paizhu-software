# 测试数据使用说明

## 快速开始

测试数据已经成功插入到数据库！

### 1. 启动服务

**启动后端：**
```bash
cd backend
npm start
```

**启动前端：**
```bash
cd front
npm run dev
```

### 2. 登录系统

- 用户名：`admin`
- 密码：`admin123`

### 3. 查看报告预览

1. 登录后，点击左侧菜单"报告预览"
2. 在页面顶部选择月份：**2026年01月**
3. 点击"加载数据"或刷新页面

### 4. 预期结果

在报告预览页面应该看到以下数据：

**一、基本情况**
- ✅ 涉黑罪犯：**3人**
- ✅ 涉恶罪犯：**2人**
- ✅ 禁闭处分：**3人**
- ✅ 记过处分：**4人**

**六、其他工作**
- ✅ 收到信件：**8封**

---

## 测试Excel数据优先级

### 场景1：只有Excel数据（当前状态）

**当前状态：** 已插入Excel测试数据

**预期结果：**
- 报告预览显示Excel统计的数据
- 涉黑3人、涉恶2人、禁闭3人、记过4人、信件8封

### 场景2：手动填写数据

1. 在报告预览页面，点击"编辑数据"
2. 手动修改"涉黑罪犯"为10人
3. 保存

**预期结果：**
- 因为Excel有数据，所以仍然显示3人（Excel优先）
- 手动填写的10人被Excel数据覆盖

### 场景3：删除Excel数据

```bash
cd backend
node scripts/clear-test-data.js
```

然后刷新报告预览页面。

**预期结果：**
- 如果之前手动填写了数据，会显示手动填写的值
- 如果没有手动填写，显示0

---

## 测试数据隔离

### 验证派驻单位隔离

当前测试数据的派驻单位是：**女子监狱**

**测试步骤：**

1. 创建另一个派驻单位的数据：
```bash
cd backend
node scripts/insert-test-data-male-prison.js
```

2. 切换用户或修改用户的派驻单位

3. 查看报告预览

**预期结果：**
- 女子监狱的用户只能看到女子监狱的数据（3涉黑、2涉恶等）
- 男子监狱的用户只能看到男子监狱的数据
- 两个派驻单位的数据完全隔离

---

## API测试

### 使用curl测试

**1. 登录获取token：**
```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

**2. 获取月度基本信息：**
```bash
curl http://localhost:3000/api/monthly-basic-info/2026-01 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**预期返回：**
```json
{
  "success": true,
  "data": {
    "gang_related": 3,
    "evil_forces": 2,
    "confinement_punishments": 3,
    "recorded_punishments": 4,
    "mail_count": 8,
    ...
  }
}
```

---

## 查看数据库

### 直接查询数据库

```sql
-- 查看涉黑恶名单
SELECT * FROM blacklists WHERE prison_name = '女子监狱';

-- 查看禁闭审批
SELECT * FROM confinements WHERE prison_name = '女子监狱';

-- 查看严管教育
SELECT * FROM strict_educations WHERE prison_name = '女子监狱';

-- 查看戒具使用
SELECT * FROM restraint_usages WHERE prison_name = '女子监狱';

-- 查看信件汇总
SELECT * FROM mail_records WHERE prison_name = '女子监狱';
```

### 统计数据

```sql
-- 统计涉黑涉恶人数
SELECT 
    COUNT(CASE WHEN involvement_type LIKE '%涉黑%' THEN 1 END) as gang_count,
    COUNT(CASE WHEN involvement_type LIKE '%涉恶%' THEN 1 END) as evil_count
FROM blacklists
WHERE prison_name = '女子监狱';

-- 统计禁闭人数（2026年1月）
SELECT COUNT(DISTINCT prisoner_id) as count
FROM confinements
WHERE prison_name = '女子监狱'
  AND create_date >= '2026-01-01'
  AND create_date <= '2026-01-31';

-- 统计严管教育人数（2026年1月）
SELECT COUNT(DISTINCT prisoner_id) as count
FROM strict_educations
WHERE prison_name = '女子监狱'
  AND create_date >= '2026-01-01'
  AND create_date <= '2026-01-31';

-- 统计信件数量（2026年1月）
SELECT COUNT(*) as count
FROM mail_records
WHERE prison_name = '女子监狱'
  AND open_date >= '2026-01-01'
  AND open_date <= '2026-01-31';
```

---

## 清理测试数据

### 清理所有测试数据

```bash
cd backend
node scripts/clear-test-data.js
```

### 手动清理

```sql
DELETE FROM blacklists WHERE prison_name = '女子监狱';
DELETE FROM confinements WHERE prison_name = '女子监狱';
DELETE FROM strict_educations WHERE prison_name = '女子监狱';
DELETE FROM restraint_usages WHERE prison_name = '女子监狱';
DELETE FROM mail_records WHERE prison_name = '女子监狱';
```

---

## 故障排查

### 问题1：数据不显示

**可能原因：**
1. 用户没有设置`prison_name`
2. 月份选择错误（应该选择2026-01）
3. 后端服务未启动

**解决方法：**
```bash
# 检查用户派驻单位
node scripts/check-user-prison-name.js

# 检查数据库中的数据
mysql -u root -p paizhu_db -e "SELECT COUNT(*) FROM blacklists WHERE prison_name='女子监狱';"
```

### 问题2：数据不正确

**可能原因：**
1. 数据库中有旧数据
2. 优先级逻辑有问题

**解决方法：**
```bash
# 清理旧数据后重新插入
node scripts/clear-test-data.js
node scripts/insert-test-data.js

# 测试优先级逻辑
node scripts/test-data-priority.js
```

### 问题3：数据隔离失败

**可能原因：**
1. `prison_name`字段未正确设置
2. 查询时未按`prison_name`过滤

**解决方法：**
```bash
# 测试数据隔离
node scripts/test-data-isolation.js
```

---

## 测试清单

- [ ] 测试数据已插入
- [ ] 后端服务已启动
- [ ] 前端服务已启动
- [ ] 可以登录系统
- [ ] 报告预览显示正确数据
- [ ] Excel数据优先级正常
- [ ] 数据隔离正常
- [ ] API返回正确

---

## 下一步

测试完成后，你可以：

1. **创建实际的Excel文件**：按照`测试文件说明.md`中的格式创建真实的Excel文件
2. **测试上传功能**：通过前端"材料上传"页面上传Excel文件
3. **验证Word导出**：测试报告的Word导出功能
4. **测试归档功能**：测试一键归档功能

---

## 相关文档

- `测试文件说明.md` - 详细的测试数据说明
- `文档/Excel文件数据统计说明.md` - Excel数据统计逻辑
- `文档/Excel数据优先级逻辑完成说明.md` - 优先级逻辑说明
- `文档/Excel数据按派驻单位隔离完成说明.md` - 数据隔离说明
