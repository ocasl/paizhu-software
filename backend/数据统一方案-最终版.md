# 数据统一方案 - 最终版

## 🎯 核心原则

**所有操作都依赖数据库，数据库是啥就显示啥**

- 用户编辑 → UPDATE 数据库
- 上传Excel → UPDATE 数据库  
- 上传Word → UPDATE 数据库
- 显示报告 → SELECT 数据库
- 下载Word → SELECT 数据库 → 填充模板

## 📊 数据表设计

### 1. 报告预览 - monthly_basic_info 表

#### 当前状态（24个字段）
- 罪犯构成：19个字段
- 违纪统计：4个字段
- 信件统计：1个字段

#### 需要添加（21个字段）
- 执法检察情况：9个字段
- 安全防范检察：2个字段
- 个别谈话：6个字段
- 会议活动：3个字段
- 其他工作：1个字段

#### 实施方案
执行SQL脚本：`backend/add_missing_fields_to_monthly_basic_info.sql`

```sql
-- 添加21个缺失字段
ALTER TABLE monthly_basic_info ADD COLUMN parole_batch VARCHAR(50);
ALTER TABLE monthly_basic_info ADD COLUMN parole_count INT DEFAULT 0;
-- ... 等等
```

#### 实施后
- 数据库字段：45个
- 报告预览可编辑字段：45个
- 一致性：✅ 100%

### 2. 报告清单 - report_checklist_items 表

#### 当前状态（已完成）✅
- 16个标准报告事项
- 每个项目3个可编辑字段：
  - `content` - 报告内容
  - `situation` - 检察情况
  - `check_time` - 记录时间
- 唯一索引：`prison_name + year + month + item_id`

#### 数据一致性
- 数据库字段：3个（content, situation, check_time）
- 清单可编辑字段：3个
- 一致性：✅ 100%

## 🔄 数据流程

### 报告预览页面

```
用户操作 → 前端 → 后端API → monthly_basic_info 表
                                      ↓
                              SELECT 查询
                                      ↓
                              前端显示数据
```

**API路由**：
- 查询：`GET /api/monthly-basic-info/:month?prison_name=xxx`
- 保存：`POST /api/monthly-basic-info`
- 下载：`GET /api/reports/generate-report?year=2026&month=02&prison_name=xxx`

### 报告清单页面

```
用户操作 → 前端 → 后端API → report_checklist_items 表
                                      ↓
                              SELECT 查询
                                      ↓
                              前端显示数据
```

**API路由**：
- 查询：`GET /api/checklist-items?prison_name=xxx&year=2026&month=2`
- 保存：`POST /api/checklist-items`
- 下载：`POST /api/reports/generate-checklist`

### 月度归档管理

```
用户点击下载 → 后端查询 monthly_basic_info + report_checklist_items
                              ↓
                      填充Word模板
                              ↓
                      返回文件下载
```

**API路由**：
- 报告预览：`GET /api/archive/download-report/:id`
- 报告清单：`GET /api/archive/download-checklist/:id`
- 一键打包：`GET /api/archive/download/:id`

## 📝 实施步骤

### 第1步：添加缺失字段到 monthly_basic_info 表

```bash
# 执行SQL脚本
mysql -u root -proot paizhu_db < backend/add_missing_fields_to_monthly_basic_info.sql
```

### 第2步：更新 MonthlyBasicInfo 模型

在 `backend/models/MonthlyBasicInfo.js` 中添加21个新字段的定义。

### 第3步：更新前端 store

在 `front/src/stores/report.js` 中，确保 `basicInfo` 对象包含所有45个字段。

### 第4步：更新保存逻辑

在报告预览页面的 `saveBasicInfo()` 函数中，将所有45个字段都发送到后端。

### 第5步：更新下载逻辑

确保所有下载功能都从 `monthly_basic_info` 表读取完整数据。

### 第6步：测试

1. 编辑报告预览中的所有字段
2. 保存到数据库
3. 刷新页面，确认数据正确显示
4. 下载Word文档，确认所有字段都正确填充

## ✅ 验证清单

- [ ] SQL脚本执行成功，添加了21个字段
- [ ] MonthlyBasicInfo 模型包含45个字段
- [ ] 报告预览页面可以编辑所有45个字段
- [ ] 保存功能正常，所有字段都写入数据库
- [ ] 刷新页面后，所有字段都正确显示
- [ ] 下载报告功能正常，所有字段都正确填充
- [ ] 下载清单功能正常，16个项目都正确显示
- [ ] 月度归档管理的下载功能正常

## 🎉 预期结果

实施完成后：

1. **报告预览**：45个可编辑字段 = 45个数据库字段 ✅
2. **报告清单**：3个可编辑字段 × 16个项目 = 数据库记录 ✅
3. **数据一致性**：100% ✅
4. **所有操作都依赖数据库**：✅

## 📌 注意事项

1. **数据迁移**：执行SQL脚本后，旧数据的新字段会是默认值（0或空字符串）
2. **前端兼容**：确保前端代码能处理字段为空的情况
3. **权限控制**：只有检察官可以编辑本单位的数据
4. **数据隔离**：所有查询都必须带上 `prison_name` 和 `report_month` 条件

## 🔧 后续优化

1. 考虑添加字段变更历史记录
2. 考虑添加数据审核流程
3. 考虑添加数据导出功能（Excel）
4. 考虑添加数据对比功能（月度对比）
