# 数据统一方案

## 核心原则

**报告预览中所有可编辑的字段 = monthly_basic_info 表的字段**

数据库是啥就显示啥，不需要从日检察记录计算！

## 当前问题

1. ✅ 罪犯构成数据：已经从 `monthly_basic_info` 读取
2. ✅ 违纪统计（记过、禁闭）：已经从 `monthly_basic_info` 读取
3. ❌ 信件数量：还在从 `otherWork.lettersReceived` 读取（被 watch 重置为0）
4. ❌ 其他统计：可能也有类似问题

## 解决步骤

### 1. 添加数据库字段

```sql
ALTER TABLE monthly_basic_info 
ADD COLUMN letters_received INT DEFAULT 0 COMMENT '收到信件数量';
```

执行：
```bash
mysql -u root -proot < backend/add_letters_received_field.sql
```

### 2. 信件上传时更新字段

已完成 ✅ - `backend/routes/templateSync.js` 中信件上传会更新 `letters_received`

### 3. 前端显示从 basicInfo 读取

已完成 ✅ - `front/src/views/ReportPreview.vue` 改为显示 `basicInfo.lettersReceived`

### 4. 加载数据时设置字段

已完成 ✅ - `ReportPreview.vue` 加载数据时会设置 `basicInfo.lettersReceived`

### 5. 模型定义添加字段

已完成 ✅ - `backend/models/MonthlyBasicInfo.js` 添加了 `letters_received` 字段

### 6. store 添加字段

已完成 ✅ - `front/src/stores/report.js` 的 `basicInfo` 添加了 `lettersReceived` 字段

## 测试步骤

1. 执行SQL添加字段
2. 重启服务
3. 重新上传信件Excel
4. 查看报告预览 → 应该显示"收到信件: 40 封"
5. 下载报告 → Word中应该有信件数量
6. 下载清单 → Word中应该有信件数量

## 数据流程

```
Excel上传 → mail_records 表（40条记录）
           ↓
        同步更新
           ↓
    monthly_basic_info.letters_received = 40
           ↓
    报告预览显示 40 封
           ↓
    下载Word文档包含 40 封
```

## 注意事项

1. **不要从日检察记录计算**：日检察记录中的 `mailbox.receivedCount` 是手动填写的，不准确
2. **以 Excel 上传为准**：Excel 有多少条记录，就是多少封信件
3. **直接覆盖更新**：后上传的数据覆盖先上传的，没有优先级概念
4. **数据隔离**：按「监狱名称 + 月份」隔离数据

## 完成标志

当你看到：
- ✅ 报告预览显示"收到信件: 40 封"
- ✅ 数据库 `monthly_basic_info.letters_received = 40`
- ✅ 下载的Word文档中有"收到信件 40 封"

说明数据已经统一了！
