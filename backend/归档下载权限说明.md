# 归档下载权限说明

## 权限模型

系统使用 `user_prison_scopes` 表来管理用户的监狱访问权限，支持一个用户管理多个监狱。

### 数据库表结构

```sql
CREATE TABLE user_prison_scopes (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL COMMENT '用户ID',
  prison_name VARCHAR(100) NOT NULL COMMENT '监狱名称',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_user_id (user_id),
  INDEX idx_prison_name (prison_name),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

### 权限函数：getUserPrisonScope(userId, userRole)

返回值：
- `'ALL'` - 可以访问所有监狱（院领导、管理员）
- `['女子监狱', '男子监狱']` - 可以访问的监狱列表（分管领导）
- `['女子监狱']` - 只能访问自己的监狱（检察官）

## 下载权限规则

### 1. 检察官（inspector）
```javascript
prisonScope = [user.prison_name]  // 只有自己的监狱
```
- ✅ 可以下载：**本单位的所有归档**
- ❌ 不能下载：其他单位的归档

### 2. 分管领导（leader）
```javascript
prisonScope = ['女子监狱', '男子监狱']  // 从 user_prison_scopes 表查询
```
- ✅ 可以下载：**所有分管监狱的归档**
- ❌ 不能下载：不在分管范围内的监狱归档

**示例**：
- 领导A 分管 `['女子监狱', '男子监狱']`
  - ✅ 可以下载女子监狱的归档
  - ✅ 可以下载男子监狱的归档
  - ❌ 不能下载未成年犯管教所的归档

### 3. 院领导（top_viewer）
```javascript
prisonScope = 'ALL'
```
- ✅ 可以下载：**所有监狱的所有归档**

### 4. 管理员（admin）
```javascript
prisonScope = 'ALL'
```
- ✅ 可以下载：**所有监狱的所有归档**

## 权限检查代码

```javascript
// 获取用户的监狱访问范围
const { getUserPrisonScope } = require('../middleware/permission')
const prisonScope = await getUserPrisonScope(req.user.id, req.user.role)

// 检查是否有权限访问该监狱
if (prisonScope !== 'ALL') {
    if (!Array.isArray(prisonScope) || !prisonScope.includes(archive.prison_name)) {
        return res.status(403).json({
            success: false,
            message: '无权下载该监狱的归档'
        })
    }
}
```

## 配置分管领导的监狱范围

### 方法1：通过管理后台（推荐）

在用户管理页面，编辑分管领导，勾选负责的监狱。

### 方法2：直接插入数据库

```sql
-- 为分管领导（user_id=43）分配女子监狱和男子监狱
INSERT INTO user_prison_scopes (user_id, prison_name) VALUES
(43, '女子监狱'),
(43, '男子监狱');

-- 查询某个领导的分管范围
SELECT prison_name FROM user_prison_scopes WHERE user_id = 43;
```

## 权限矩阵

| 角色 | 权限范围 | 数据来源 | 示例 |
|------|---------|---------|------|
| **检察官** | 本单位 | `users.prison_name` | `['女子监狱']` |
| **分管领导** | 多个单位 | `user_prison_scopes` 表 | `['女子监狱', '男子监狱']` |
| **院领导** | 所有单位 | 固定返回 `'ALL'` | `'ALL'` |
| **管理员** | 所有单位 | 固定返回 `'ALL'` | `'ALL'` |

## 应用场景

### 场景1：检察官下载归档
- 张三（检察官，女子监狱）
- ✅ 可以下载：女子监狱 2026年1月归档
- ❌ 不能下载：男子监狱 2026年1月归档

### 场景2：分管领导下载归档
- 李四（分管领导，负责女子监狱+男子监狱）
- ✅ 可以下载：女子监狱 2026年1月归档
- ✅ 可以下载：男子监狱 2026年1月归档
- ❌ 不能下载：未成年犯管教所 2026年1月归档

### 场景3：院领导下载归档
- 王五（院领导）
- ✅ 可以下载：所有监狱的所有归档

## 注意事项

1. **检察官的 prison_name 字段**：
   - 仍然保留在 `users` 表中
   - 用于标识检察官所属的监狱
   - 不需要在 `user_prison_scopes` 表中重复

2. **分管领导的 prison_name 字段**：
   - 可以为空或设置为主要负责的监狱
   - 实际权限以 `user_prison_scopes` 表为准

3. **院领导和管理员**：
   - 不需要在 `user_prison_scopes` 表中配置
   - 直接返回 `'ALL'` 权限

## 相关文件

- `backend/middleware/permission.js` - 权限检查函数
- `backend/routes/archive.js` - 归档下载路由
- `backend/models/UserPrisonScope.js` - 数据模型
- `backend/migrations/paizhu_db.sql` - 数据库结构
