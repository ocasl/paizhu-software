<script setup>
import { ref, computed, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { useUserStore } from '../stores/user'
import axios from 'axios'

const userStore = useUserStore()
const isAdmin = computed(() => userStore.userInfo?.role === 'admin')

// API ÈÖçÁΩÆ
const API_BASE = import.meta.env.VITE_API_URL || 'http://localhost:3000'

function getToken() {
  return localStorage.getItem('token')
}

// ÂàõÂª∫ axios ÂÆû‰æãÂπ∂ÈÖçÁΩÆÊã¶Êà™Âô®
const api = axios.create({
  baseURL: API_BASE,
  headers: { 'Content-Type': 'application/json' }
})

api.interceptors.request.use(config => {
  const token = getToken()
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})

// Êï∞ÊçÆ
const categories = ref([])
const documents = ref([])
const loading = ref(false)
const total = ref(0)
const currentPage = ref(1)
const pageSize = ref(20)

// ÊêúÁ¥¢ÂíåÁ≠õÈÄâ
const keyword = ref('')
const selectedCategory = ref('')

// ÂØπËØùÊ°Ü
const categoryDialogVisible = ref(false)
const categoryFormMode = ref('add') // 'add' or 'edit'
const categoryForm = ref({
  id: null,
  name: '',
  description: '',
  sort_order: 0,
  is_active: true
})

const uploadDialogVisible = ref(false)
const uploadForm = ref({
  title: '',
  description: '',
  category_id: '',
  file: null
})
const uploadFileList = ref([])

const editDialogVisible = ref(false)
const editForm = ref({
  id: null,
  title: '',
  description: '',
  category_id: ''
})

const pdfPreviewVisible = ref(false)
const pdfPreviewUrl = ref('')
const docxPreviewVisible = ref(false)
const docxPreviewHtml = ref('')

// Ëé∑ÂèñÂàÜÁ±ªÂàóË°®
async function fetchCategories() {
  try {
    const res = await api.get('/api/compilation/categories')
    if (res.data.success) {
      categories.value = res.data.data
    }
  } catch (error) {
    console.error('Ëé∑ÂèñÂàÜÁ±ªÂ§±Ë¥•:', error)
    ElMessage.error('Ëé∑ÂèñÂàÜÁ±ªÂ§±Ë¥•')
  }
}

// Ëé∑ÂèñÊñáÊ°£ÂàóË°®
async function fetchDocuments() {
  loading.value = true
  try {
    const params = {
      page: currentPage.value,
      limit: pageSize.value
    }
    if (keyword.value) params.keyword = keyword.value
    if (selectedCategory.value) params.category_id = selectedCategory.value

    const res = await api.get('/api/compilation/documents', { params })
    if (res.data.success) {
      documents.value = res.data.data.documents
      total.value = res.data.data.total
    }
  } catch (error) {
    console.error('Ëé∑ÂèñÊñáÊ°£Â§±Ë¥•:', error)
    ElMessage.error('Ëé∑ÂèñÊñáÊ°£Â§±Ë¥•')
  } finally {
    loading.value = false
  }
}

// ÊêúÁ¥¢
function handleSearch() {
  currentPage.value = 1
  fetchDocuments()
}

// ÂàÜÁ±ªÁ≠õÈÄâ
function handleCategoryFilter() {
  currentPage.value = 1
  fetchDocuments()
}

// ÂàÜÈ°µ
function handlePageChange(page) {
  currentPage.value = page
  fetchDocuments()
}

// ========== ÂàÜÁ±ªÁÆ°ÁêÜ ==========

function openCategoryDialog(mode = 'add', category = null) {
  categoryFormMode.value = mode
  if (mode === 'edit' && category) {
    categoryForm.value = { ...category }
  } else {
    categoryForm.value = {
      id: null,
      name: '',
      description: '',
      sort_order: 0,
      is_active: true
    }
  }
  categoryDialogVisible.value = true
}

async function submitCategoryForm() {
  try {
    if (!categoryForm.value.name) {
      ElMessage.warning('ËØ∑ËæìÂÖ•ÂàÜÁ±ªÂêçÁß∞')
      return
    }

    if (categoryFormMode.value === 'add') {
      const res = await api.post('/api/compilation/categories', categoryForm.value)
      if (res.data.success) {
        ElMessage.success('ÂàÜÁ±ªÊ∑ªÂä†ÊàêÂäü')
        categoryDialogVisible.value = false
        fetchCategories()
      }
    } else {
      const res = await api.put(`/api/compilation/categories/${categoryForm.value.id}`, categoryForm.value)
      if (res.data.success) {
        ElMessage.success('ÂàÜÁ±ªÊõ¥Êñ∞ÊàêÂäü')
        categoryDialogVisible.value = false
        fetchCategories()
        fetchDocuments()
      }
    }
  } catch (error) {
    console.error('‰øùÂ≠òÂàÜÁ±ªÂ§±Ë¥•:', error)
    ElMessage.error(error.response?.data?.message || '‰øùÂ≠òÂàÜÁ±ªÂ§±Ë¥•')
  }
}

async function deleteCategory(category) {
  try {
    await ElMessageBox.confirm(
      `Á°ÆÂÆöË¶ÅÂà†Èô§ÂàÜÁ±ª"${category.name}"ÂêóÔºü`,
      'Âà†Èô§Á°ÆËÆ§',
      {
        confirmButtonText: 'Á°ÆÂÆö',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
      }
    )

    const res = await api.delete(`/api/compilation/categories/${category.id}`)
    if (res.data.success) {
      ElMessage.success('ÂàÜÁ±ªÂà†Èô§ÊàêÂäü')
      fetchCategories()
    }
  } catch (error) {
    if (error !== 'cancel') {
      console.error('Âà†Èô§ÂàÜÁ±ªÂ§±Ë¥•:', error)
      ElMessage.error(error.response?.data?.message || 'Âà†Èô§ÂàÜÁ±ªÂ§±Ë¥•')
    }
  }
}

// ========== ÊñáÊ°£ÁÆ°ÁêÜ ==========

function openUploadDialog() {
  uploadForm.value = {
    title: '',
    description: '',
    category_id: '',
    file: null
  }
  uploadFileList.value = []
  uploadDialogVisible.value = true
}

function handleFileChange(file) {
  uploadForm.value.file = file.raw
}

function handleFileRemove() {
  uploadForm.value.file = null
}

async function submitUploadForm() {
  try {
    if (!uploadForm.value.title) {
      ElMessage.warning('ËØ∑ËæìÂÖ•ÊñáÊ°£Ê†áÈ¢ò')
      return
    }
    if (!uploadForm.value.category_id) {
      ElMessage.warning('ËØ∑ÈÄâÊã©ÂàÜÁ±ª')
      return
    }
    if (!uploadForm.value.file) {
      ElMessage.warning('ËØ∑ÈÄâÊã©Êñá‰ª∂')
      return
    }

    const formData = new FormData()
    formData.append('title', uploadForm.value.title)
    formData.append('description', uploadForm.value.description || '')
    formData.append('category_id', uploadForm.value.category_id)
    formData.append('file', uploadForm.value.file)

    const res = await api.post('/api/compilation/documents', formData, {
      headers: { 'Content-Type': 'multipart/form-data' }
    })

    if (res.data.success) {
      ElMessage.success('ÊñáÊ°£‰∏ä‰º†ÊàêÂäü')
      uploadDialogVisible.value = false
      fetchDocuments()
    }
  } catch (error) {
    console.error('‰∏ä‰º†ÊñáÊ°£Â§±Ë¥•:', error)
    ElMessage.error(error.response?.data?.message || '‰∏ä‰º†ÊñáÊ°£Â§±Ë¥•')
  }
}

function openEditDialog(doc) {
  editForm.value = {
    id: doc.id,
    title: doc.title,
    description: doc.description,
    category_id: doc.category_id
  }
  editDialogVisible.value = true
}

async function submitEditForm() {
  try {
    if (!editForm.value.title) {
      ElMessage.warning('ËØ∑ËæìÂÖ•ÊñáÊ°£Ê†áÈ¢ò')
      return
    }

    const res = await api.put(`/api/compilation/documents/${editForm.value.id}`, editForm.value)
    if (res.data.success) {
      ElMessage.success('ÊñáÊ°£Êõ¥Êñ∞ÊàêÂäü')
      editDialogVisible.value = false
      fetchDocuments()
    }
  } catch (error) {
    console.error('Êõ¥Êñ∞ÊñáÊ°£Â§±Ë¥•:', error)
    ElMessage.error(error.response?.data?.message || 'Êõ¥Êñ∞ÊñáÊ°£Â§±Ë¥•')
  }
}

async function deleteDocument(doc) {
  try {
    await ElMessageBox.confirm(
      `Á°ÆÂÆöË¶ÅÂà†Èô§ÊñáÊ°£"${doc.title}"ÂêóÔºü`,
      'Âà†Èô§Á°ÆËÆ§',
      {
        confirmButtonText: 'Á°ÆÂÆö',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
      }
    )

    const res = await api.delete(`/api/compilation/documents/${doc.id}`)
    if (res.data.success) {
      ElMessage.success('ÊñáÊ°£Âà†Èô§ÊàêÂäü')
      fetchDocuments()
    }
  } catch (error) {
    if (error !== 'cancel') {
      console.error('Âà†Èô§ÊñáÊ°£Â§±Ë¥•:', error)
      ElMessage.error(error.response?.data?.message || 'Âà†Èô§ÊñáÊ°£Â§±Ë¥•')
    }
  }
}

async function togglePin(doc) {
  try {
    const res = await api.put(`/api/compilation/documents/${doc.id}/pin`, {
      is_pinned: !doc.is_pinned
    })
    if (res.data.success) {
      ElMessage.success(doc.is_pinned ? 'Â∑≤ÂèñÊ∂àÁΩÆÈ°∂' : 'Â∑≤ÁΩÆÈ°∂')
      fetchDocuments()
    }
  } catch (error) {
    console.error('ÁΩÆÈ°∂Êìç‰ΩúÂ§±Ë¥•:', error)
    ElMessage.error('ÁΩÆÈ°∂Êìç‰ΩúÂ§±Ë¥•')
  }
}

function downloadDocument(doc) {
  const token = getToken()
  const url = `${API_BASE}/api/compilation/documents/${doc.id}/download`
  
  // ‰ΩøÁî® fetch ‰∏ãËΩΩÂπ∂Â∏¶‰∏ä token
  fetch(url, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(response => response.blob())
  .then(blob => {
    const blobUrl = window.URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = blobUrl
    link.download = doc.file_name
    link.click()
    window.URL.revokeObjectURL(blobUrl)
  })
  .catch(error => {
    console.error('‰∏ãËΩΩÂ§±Ë¥•:', error)
    ElMessage.error('‰∏ãËΩΩÂ§±Ë¥•')
  })
}

function previewDocument(doc) {
  if (doc.file_type === 'pdf') {
    // PDF È¢ÑËßà
    const token = getToken()
    const url = `${API_BASE}/api/compilation/documents/${doc.id}/preview`
    
    fetch(url, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('È¢ÑËßàÂ§±Ë¥•')
      }
      return response.blob()
    })
    .then(blob => {
      const blobUrl = window.URL.createObjectURL(blob)
      pdfPreviewUrl.value = blobUrl
      pdfPreviewVisible.value = true
    })
    .catch(error => {
      console.error('È¢ÑËßàÂ§±Ë¥•:', error)
      ElMessage.error('È¢ÑËßàÂ§±Ë¥•ÔºåËØ∑Â∞ùËØï‰∏ãËΩΩÊü•Áúã')
    })
  } else {
    // DOCX È¢ÑËßàÔºàËΩ¨Êç¢‰∏∫ HTMLÔºâ
    api.get(`/api/compilation/documents/${doc.id}/preview-docx`)
      .then(res => {
        if (res.data.success) {
          docxPreviewHtml.value = res.data.data.html
          docxPreviewVisible.value = true
        }
      })
      .catch(error => {
        console.error('È¢ÑËßàÂ§±Ë¥•:', error)
        ElMessage.error('È¢ÑËßàÂ§±Ë¥•ÔºåËØ∑Â∞ùËØï‰∏ãËΩΩÊü•Áúã')
      })
  }
}

// Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
function formatFileSize(bytes) {
  if (!bytes) return '0 B'
  const k = 1024
  const sizes = ['B', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i]
}

// Ê†ºÂºèÂåñÊó•Êúü
function formatDate(date) {
  if (!date) return ''
  return new Date(date).toLocaleDateString('zh-CN')
}

// ÁΩÆÈ°∂ÊñáÊ°£
const pinnedDocuments = computed(() => {
  return documents.value.filter(doc => doc.is_pinned)
})

// ÊôÆÈÄöÊñáÊ°£ÔºàÊåâÂàÜÁ±ªÂàÜÁªÑÔºâ
const documentsByCategory = computed(() => {
  const normalDocs = documents.value.filter(doc => !doc.is_pinned)
  const grouped = {}
  
  normalDocs.forEach(doc => {
    const categoryName = doc.category?.name || 'Êú™ÂàÜÁ±ª'
    if (!grouped[categoryName]) {
      grouped[categoryName] = []
    }
    grouped[categoryName].push(doc)
  })
  
  return grouped
})

onMounted(() => {
  fetchCategories()
  fetchDocuments()
})
</script>

<template>
  <div class="compilation-container">
    <!-- È°µÈù¢Â§¥ÈÉ® -->
    <div class="page-header">
      <div class="header-left">
        <h1 class="page-title">üìö Ê±áÁºñ</h1>
        <p class="page-subtitle">Ê£ÄÂØüÂ∑•‰ΩúÊñáÊ°£ËµÑÊñôÂ∫ì</p>
      </div>
      <div class="header-right">
        <el-button v-if="isAdmin" type="primary" @click="openCategoryDialog('add')">
          ÁÆ°ÁêÜÂàÜÁ±ª
        </el-button>
        <el-button v-if="isAdmin" type="success" @click="openUploadDialog">
          ‰∏ä‰º†ÊñáÊ°£
        </el-button>
      </div>
    </div>

    <!-- ÊêúÁ¥¢ÂíåÁ≠õÈÄâ -->
    <div class="filter-bar">
      <el-input
        v-model="keyword"
        placeholder="ÊêúÁ¥¢ÊñáÊ°£Ê†áÈ¢òÊàñÊèèËø∞..."
        clearable
        @clear="handleSearch"
        @keyup.enter="handleSearch"
        style="width: 400px"
      >
        <template #prefix>
          <el-icon><Search /></el-icon>
        </template>
      </el-input>
      
      <el-select
        v-model="selectedCategory"
        placeholder="ÈÄâÊã©ÂàÜÁ±ª"
        clearable
        @change="handleCategoryFilter"
        style="width: 200px; margin-left: 10px"
      >
        <el-option
          v-for="cat in categories.filter(c => c.is_active)"
          :key="cat.id"
          :label="cat.name"
          :value="cat.id"
        />
      </el-select>

      <el-button type="primary" @click="handleSearch" style="margin-left: 10px">
        ÊêúÁ¥¢
      </el-button>
    </div>

    <!-- ÁΩÆÈ°∂ÊñáÊ°£ -->
    <div v-if="pinnedDocuments.length > 0" class="pinned-section">
      <div class="section-title">
        <el-icon><Star /></el-icon>
        <span>ÁΩÆÈ°∂ÊñáÊ°£ ({{ pinnedDocuments.length }})</span>
      </div>
      <div class="document-list">
        <div v-for="doc in pinnedDocuments" :key="doc.id" class="document-card pinned">
          <div class="doc-header">
            <div class="doc-icon">
              <el-icon v-if="doc.file_type === 'pdf'" color="#f56c6c" :size="24"><Document /></el-icon>
              <el-icon v-else color="#409eff" :size="24"><Document /></el-icon>
            </div>
            <div class="doc-info">
              <h3 class="doc-title">
                <el-tag type="warning" size="small" style="margin-right: 8px">ÁΩÆÈ°∂</el-tag>
                {{ doc.title }}
              </h3>
              <p class="doc-meta">
                <el-tag size="small">{{ doc.category?.name }}</el-tag>
                <span>{{ doc.file_type.toUpperCase() }}</span>
                <span>{{ formatFileSize(doc.file_size) }}</span>
                <span>{{ formatDate(doc.created_at) }}</span>
              </p>
              <p v-if="doc.description" class="doc-description">{{ doc.description }}</p>
            </div>
          </div>
          <div class="doc-actions">
            <el-button size="small" @click="previewDocument(doc)">
              <el-icon><View /></el-icon> È¢ÑËßà
            </el-button>
            <el-button size="small" @click="downloadDocument(doc)">
              <el-icon><Download /></el-icon> ‰∏ãËΩΩ
            </el-button>
            <template v-if="isAdmin">
              <el-button size="small" @click="openEditDialog(doc)">
                <el-icon><Edit /></el-icon> ÁºñËæë
              </el-button>
              <el-button size="small" @click="togglePin(doc)">
                <el-icon><Star /></el-icon> ÂèñÊ∂àÁΩÆÈ°∂
              </el-button>
              <el-button size="small" type="danger" @click="deleteDocument(doc)">
                <el-icon><Delete /></el-icon> Âà†Èô§
              </el-button>
            </template>
          </div>
          <div class="doc-stats">
            <span><el-icon><View /></el-icon> {{ doc.view_count }}Ê¨°</span>
            <span><el-icon><Download /></el-icon> {{ doc.download_count }}Ê¨°</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ÊñáÊ°£ÂàóË°®ÔºàÊåâÂàÜÁ±ªÂàÜÁªÑÔºâ -->
    <div v-loading="loading" class="documents-section">
      <div v-for="(docs, categoryName) in documentsByCategory" :key="categoryName" class="category-group">
        <div class="section-title">
          <el-icon><Folder /></el-icon>
          <span>{{ categoryName }} ({{ docs.length }})</span>
        </div>
        <div class="document-list">
          <div v-for="doc in docs" :key="doc.id" class="document-card">
            <div class="doc-header">
              <div class="doc-icon">
                <el-icon v-if="doc.file_type === 'pdf'" color="#f56c6c" :size="24"><Document /></el-icon>
                <el-icon v-else color="#409eff" :size="24"><Document /></el-icon>
              </div>
              <div class="doc-info">
                <h3 class="doc-title">{{ doc.title }}</h3>
                <p class="doc-meta">
                  <span>{{ doc.file_type.toUpperCase() }}</span>
                  <span>{{ formatFileSize(doc.file_size) }}</span>
                  <span>{{ formatDate(doc.created_at) }}</span>
                </p>
                <p v-if="doc.description" class="doc-description">{{ doc.description }}</p>
              </div>
            </div>
            <div class="doc-actions">
              <el-button size="small" @click="previewDocument(doc)">
                <el-icon><View /></el-icon> È¢ÑËßà
              </el-button>
              <el-button size="small" @click="downloadDocument(doc)">
                <el-icon><Download /></el-icon> ‰∏ãËΩΩ
              </el-button>
              <template v-if="isAdmin">
                <el-button size="small" @click="openEditDialog(doc)">
                  <el-icon><Edit /></el-icon> ÁºñËæë
                </el-button>
                <el-button size="small" @click="togglePin(doc)">
                  <el-icon><Star /></el-icon> ÁΩÆÈ°∂
                </el-button>
                <el-button size="small" type="danger" @click="deleteDocument(doc)">
                  <el-icon><Delete /></el-icon> Âà†Èô§
                </el-button>
              </template>
            </div>
            <div class="doc-stats">
              <span><el-icon><View /></el-icon> {{ doc.view_count }}Ê¨°</span>
              <span><el-icon><Download /></el-icon> {{ doc.download_count }}Ê¨°</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Á©∫Áä∂ÊÄÅ -->
      <el-empty v-if="!loading && documents.length === 0" description="ÊöÇÊó†ÊñáÊ°£" />
    </div>

    <!-- ÂàÜÈ°µ -->
    <div v-if="total > pageSize" class="pagination">
      <el-pagination
        v-model:current-page="currentPage"
        :page-size="pageSize"
        :total="total"
        layout="total, prev, pager, next"
        @current-change="handlePageChange"
      />
    </div>

    <!-- ÂàÜÁ±ªÁÆ°ÁêÜÂØπËØùÊ°Ü -->
    <el-dialog
      v-model="categoryDialogVisible"
      :title="categoryFormMode === 'add' ? 'Ê∑ªÂä†ÂàÜÁ±ª' : 'ÁºñËæëÂàÜÁ±ª'"
      width="500px"
    >
      <el-form :model="categoryForm" label-width="100px">
        <el-form-item label="ÂàÜÁ±ªÂêçÁß∞" required>
          <el-input v-model="categoryForm.name" placeholder="ËØ∑ËæìÂÖ•ÂàÜÁ±ªÂêçÁß∞" />
        </el-form-item>
        <el-form-item label="ÂàÜÁ±ªÊèèËø∞">
          <el-input v-model="categoryForm.description" type="textarea" :rows="3" placeholder="ËØ∑ËæìÂÖ•ÂàÜÁ±ªÊèèËø∞" />
        </el-form-item>
        <el-form-item label="ÊéíÂ∫è">
          <el-input-number v-model="categoryForm.sort_order" :min="0" />
          <span style="margin-left: 10px; color: #909399; font-size: 12px">Êï∞Â≠óË∂äÂ∞èË∂äÈù†Ââç</span>
        </el-form-item>
        <el-form-item label="Áä∂ÊÄÅ">
          <el-switch v-model="categoryForm.is_active" active-text="ÂêØÁî®" inactive-text="Á¶ÅÁî®" />
        </el-form-item>
      </el-form>
      
      <!-- ÂàÜÁ±ªÂàóË°®ÔºàÁºñËæëÊ®°ÂºèÔºâ -->
      <div v-if="categoryFormMode === 'add'" style="margin-top: 20px">
        <el-divider>Áé∞ÊúâÂàÜÁ±ª</el-divider>
        <el-table :data="categories" size="small">
          <el-table-column prop="name" label="ÂàÜÁ±ªÂêçÁß∞" />
          <el-table-column prop="doc_count" label="ÊñáÊ°£Êï∞" width="80" />
          <el-table-column prop="is_active" label="Áä∂ÊÄÅ" width="80">
            <template #default="{ row }">
              <el-tag :type="row.is_active ? 'success' : 'info'" size="small">
                {{ row.is_active ? 'ÂêØÁî®' : 'Á¶ÅÁî®' }}
              </el-tag>
            </template>
          </el-table-column>
          <el-table-column label="Êìç‰Ωú" width="150">
            <template #default="{ row }">
              <el-button size="small" @click="openCategoryDialog('edit', row)">ÁºñËæë</el-button>
              <el-button size="small" type="danger" @click="deleteCategory(row)">Âà†Èô§</el-button>
            </template>
          </el-table-column>
        </el-table>
      </div>

      <template #footer>
        <el-button @click="categoryDialogVisible = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="submitCategoryForm">Á°ÆÂÆö</el-button>
      </template>
    </el-dialog>

    <!-- ‰∏ä‰º†ÊñáÊ°£ÂØπËØùÊ°Ü -->
    <el-dialog v-model="uploadDialogVisible" title="‰∏ä‰º†ÊñáÊ°£" width="600px">
      <el-form :model="uploadForm" label-width="100px">
        <el-form-item label="ÊñáÊ°£Ê†áÈ¢ò" required>
          <el-input v-model="uploadForm.title" placeholder="ËØ∑ËæìÂÖ•ÊñáÊ°£Ê†áÈ¢ò" />
        </el-form-item>
        <el-form-item label="ÊñáÊ°£ÊèèËø∞">
          <el-input v-model="uploadForm.description" type="textarea" :rows="3" placeholder="ËØ∑ËæìÂÖ•ÊñáÊ°£ÊèèËø∞" />
        </el-form-item>
        <el-form-item label="ÂàÜÁ±ª" required>
          <el-select v-model="uploadForm.category_id" placeholder="ËØ∑ÈÄâÊã©ÂàÜÁ±ª" style="width: 100%">
            <el-option
              v-for="cat in categories.filter(c => c.is_active)"
              :key="cat.id"
              :label="cat.name"
              :value="cat.id"
            />
          </el-select>
        </el-form-item>
        <el-form-item label="ÈÄâÊã©Êñá‰ª∂" required>
          <el-upload
            v-model:file-list="uploadFileList"
            :auto-upload="false"
            :limit="1"
            :on-change="handleFileChange"
            :on-remove="handleFileRemove"
            accept=".pdf,.docx"
          >
            <el-button type="primary">ÈÄâÊã©Êñá‰ª∂</el-button>
            <template #tip>
              <div class="el-upload__tip">
                Âè™ÊîØÊåÅ PDF Âíå DOCX Ê†ºÂºèÔºåÊñá‰ª∂Â§ßÂ∞è‰∏çË∂ÖËøá 50MB
              </div>
            </template>
          </el-upload>
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="uploadDialogVisible = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="submitUploadForm">‰∏ä‰º†</el-button>
      </template>
    </el-dialog>

    <!-- ÁºñËæëÊñáÊ°£ÂØπËØùÊ°Ü -->
    <el-dialog v-model="editDialogVisible" title="ÁºñËæëÊñáÊ°£" width="600px">
      <el-form :model="editForm" label-width="100px">
        <el-form-item label="ÊñáÊ°£Ê†áÈ¢ò" required>
          <el-input v-model="editForm.title" placeholder="ËØ∑ËæìÂÖ•ÊñáÊ°£Ê†áÈ¢ò" />
        </el-form-item>
        <el-form-item label="ÊñáÊ°£ÊèèËø∞">
          <el-input v-model="editForm.description" type="textarea" :rows="3" placeholder="ËØ∑ËæìÂÖ•ÊñáÊ°£ÊèèËø∞" />
        </el-form-item>
        <el-form-item label="ÂàÜÁ±ª" required>
          <el-select v-model="editForm.category_id" placeholder="ËØ∑ÈÄâÊã©ÂàÜÁ±ª" style="width: 100%">
            <el-option
              v-for="cat in categories.filter(c => c.is_active)"
              :key="cat.id"
              :label="cat.name"
              :value="cat.id"
            />
          </el-select>
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="editDialogVisible = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="submitEditForm">‰øùÂ≠ò</el-button>
      </template>
    </el-dialog>

    <!-- PDF È¢ÑËßàÂØπËØùÊ°Ü -->
    <el-dialog v-model="pdfPreviewVisible" title="ÊñáÊ°£È¢ÑËßà" width="80%" top="5vh">
      <iframe :src="pdfPreviewUrl" style="width: 100%; height: 70vh; border: none" />
    </el-dialog>

    <!-- DOCX È¢ÑËßàÂØπËØùÊ°Ü -->
    <el-dialog v-model="docxPreviewVisible" title="ÊñáÊ°£È¢ÑËßà" width="80%" top="5vh">
      <div class="docx-preview-container" v-html="docxPreviewHtml"></div>
    </el-dialog>
  </div>
</template>

<style scoped>
.compilation-container {
  padding: 20px;
  background: #f5f7fa;
  min-height: 100vh;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.header-left {
  flex: 1;
}

.page-title {
  font-size: 28px;
  font-weight: 700;
  color: #303133;
  margin: 0 0 8px 0;
}

.page-subtitle {
  font-size: 14px;
  color: #909399;
  margin: 0;
}

.header-right {
  display: flex;
  gap: 10px;
}

.filter-bar {
  margin-bottom: 20px;
  padding: 15px 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  display: flex;
  align-items: center;
}

.pinned-section,
.documents-section {
  margin-bottom: 20px;
}

.category-group {
  margin-bottom: 30px;
}

.section-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 18px;
  font-weight: 600;
  color: #303133;
  margin-bottom: 15px;
  padding: 10px 15px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.document-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.document-card {
  background: white;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
}

.document-card:hover {
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  transform: translateY(-2px);
}

.document-card.pinned {
  border: 2px solid #f56c6c;
}

.doc-header {
  display: flex;
  gap: 15px;
  margin-bottom: 15px;
}

.doc-icon {
  flex-shrink: 0;
}

.doc-info {
  flex: 1;
}

.doc-title {
  font-size: 16px;
  font-weight: 600;
  color: #303133;
  margin: 0 0 8px 0;
}

.doc-meta {
  display: flex;
  gap: 15px;
  font-size: 13px;
  color: #909399;
  margin: 0 0 8px 0;
}

.doc-description {
  font-size: 14px;
  color: #606266;
  margin: 0;
  line-height: 1.6;
}

.doc-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 10px;
}

.doc-stats {
  display: flex;
  gap: 20px;
  font-size: 13px;
  color: #909399;
  padding-top: 10px;
  border-top: 1px solid #ebeef5;
}

.doc-stats span {
  display: flex;
  align-items: center;
  gap: 4px;
}

.pagination {
  display: flex;
  justify-content: center;
  margin-top: 20px;
  padding: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* DOCX È¢ÑËßàÊ†∑Âºè */
.docx-preview-container {
  max-height: 70vh;
  overflow-y: auto;
  padding: 20px;
  background: white;
  line-height: 1.8;
}

.docx-preview-container :deep(p) {
  margin: 10px 0;
}

.docx-preview-container :deep(h1),
.docx-preview-container :deep(h2),
.docx-preview-container :deep(h3) {
  margin: 20px 0 10px 0;
  font-weight: 600;
}

.docx-preview-container :deep(img) {
  max-width: 100%;
  height: auto;
}

.docx-preview-container :deep(table) {
  border-collapse: collapse;
  width: 100%;
  margin: 15px 0;
}

.docx-preview-container :deep(table td),
.docx-preview-container :deep(table th) {
  border: 1px solid #ddd;
  padding: 8px;
}
</style>
