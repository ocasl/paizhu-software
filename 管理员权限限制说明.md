# 管理员权限限制说明

## 问题描述
系统管理员（admin）不应该能够创建检察日志，只有派驻检察官（inspector）才能创建日志。

## 权限规则

### 角色定义
- **inspector（派驻检察官）**：可以创建、编辑、删除自己监狱的日志
- **leader（分管领导）**：只能查看分管监狱的日志，不能创建
- **top_viewer（院领导）**：只能查看所有监狱的日志，不能创建
- **admin（系统管理员）**：只能查看所有日志和管理用户，不能创建日志

### 日志创建权限
只有 **inspector** 角色可以创建以下类型的日志：
- 日检察日志
- 周检察记录
- 月检察记录
- 即时检察事件

## 修复内容

### 1. 日检察（DailyCheck.vue + dailyLogs.js）

#### 后端修复
```javascript
// backend/routes/dailyLogs.js
// 创建日检察记录（仅检察官）
router.post('/', requireRole(['inspector']), async (req, res) => {
  // ...
})
```

#### 前端修复
```javascript
// front/src/views/DailyCheck.vue
// 添加权限判断
const isInspector = computed(() => userStore.userInfo?.role === 'inspector')

// 管理员默认显示历史记录
const viewMode = ref(isInspector.value ? 'form' : 'history')
```

```vue
<!-- 隐藏管理员的"新建日志"按钮 -->
<el-radio-button v-if="isInspector" value="form">
  <el-icon><Edit /></el-icon>
  新建日志
</el-radio-button>
```

### 2. 周检察（需要修复）

**后端路由**：`backend/routes/weeklyRecords.js`
- 添加 `requireRole(['inspector'])` 到 POST 接口

**前端页面**：`front/src/views/WeeklyCheck.vue`
- 添加 `isInspector` 判断
- 隐藏管理员的创建按钮

### 3. 月检察（需要修复）

**后端路由**：`backend/routes/monthlyRecords.js`
- 添加 `requireRole(['inspector'])` 到 POST 接口

**前端页面**：`front/src/views/MonthlyCheck.vue`
- 添加 `isInspector` 判断
- 隐藏管理员的创建按钮

### 4. 即时检察（需要修复）

**后端路由**：`backend/routes/immediateEvents.js`
- 添加 `requireRole(['inspector'])` 到 POST 接口

**前端页面**：`front/src/views/ImmediateCheck.vue`
- 添加 `isInspector` 判断
- 隐藏管理员的创建按钮

## 测试验证

### 测试步骤
1. 使用管理员账号登录
2. 进入日检察页面
3. 验证：
   - ✅ 默认显示"历史记录"视图
   - ✅ 没有"新建日志"按钮
   - ✅ 可以查看所有监狱的日志
   - ✅ 尝试通过API创建日志会返回 403 错误

4. 使用检察官账号登录
5. 进入日检察页面
6. 验证：
   - ✅ 默认显示"新建日志"表单
   - ✅ 可以创建日志
   - ✅ 只能查看和编辑自己监狱的日志

### API 测试
```bash
# 使用管理员 token 尝试创建日志（应该返回 403）
curl -X POST http://localhost:3000/api/daily-logs \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \
  -d '{"log_date":"2026-02-05","prison_name":"测试监狱"}'

# 预期响应
{
  "error": "权限不足"
}
```

## 其他需要限制的功能

### 材料上传
- 当前：所有角色都可以上传
- 建议：只允许检察官上传

### 报告生成
- 当前：所有角色都可以生成
- 建议：检察官可以生成自己监狱的报告，领导可以生成分管监狱的报告

### 归档下载
- 当前：已正确实现权限控制
- ✅ 检察官：只能下载自己监狱的归档
- ✅ 分管领导：可以下载分管监狱的归档
- ✅ 院领导/管理员：可以下载所有归档

## 注意事项

1. **前后端双重验证**：前端隐藏按钮只是UI层面的限制，后端必须有权限验证
2. **错误提示**：当管理员尝试创建日志时，应该给出友好的错误提示
3. **历史数据**：已存在的由管理员创建的日志不受影响
4. **角色变更**：如果用户角色从检察官变为管理员，应该无法再创建日志

## 实施优先级

1. ✅ **高优先级**：日检察（已完成）
2. 🔴 **高优先级**：周检察、月检察、即时检察
3. 🟡 **中优先级**：材料上传
4. 🟢 **低优先级**：报告生成（可以保持现状）
