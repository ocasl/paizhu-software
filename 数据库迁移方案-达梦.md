# 派驻检察系统 - 达梦数据库迁移方案

## 一、迁移概述

### 为什么选择达梦数据库？

1. ✅ **国产化要求**：满足客户对国产数据库的要求
2. ✅ **性能优秀**：性能接近甚至超过 MySQL
3. ✅ **兼容性好**：支持标准 SQL，迁移成本相对较低
4. ✅ **生态完善**：有成熟的 Node.js 驱动和工具链
5. ✅ **技术支持**：达梦公司提供专业技术支持

### 迁移难度评估

| 项目 | 难度 | 工作量 | 说明 |
|------|------|--------|------|
| 安装达梦数据库 | ⭐ | 0.5天 | 按官方文档操作 |
| 修改连接配置 | ⭐ | 0.5天 | 更换驱动和配置 |
| 表结构迁移 | ⭐⭐ | 1天 | 调整数据类型和语法 |
| 数据迁移 | ⭐⭐ | 0.5天 | 导出导入数据 |
| SQL 语法调整 | ⭐⭐⭐ | 1天 | 修改不兼容的 SQL |
| 测试验证 | ⭐⭐ | 1天 | 全功能测试 |
| **总计** | - | **4-5天** | - |

## 二、技术方案

### 2.1 达梦数据库驱动

```bash
# 安装达梦数据库 Node.js 驱动
npm install dmdb --save
```

### 2.2 Sequelize 配置

达梦数据库可以使用 PostgreSQL 方言（兼容性较好）：

```javascript
// backend/config/database.js
const { Sequelize } = require('sequelize')

const sequelize = new Sequelize({
  dialect: 'postgres',  // 使用 postgres 方言
  dialectModule: require('dmdb'),  // 使用达梦驱动
  host: process.env.DM_HOST || 'localhost',
  port: process.env.DM_PORT || 5236,  // 达梦默认端口
  database: process.env.DM_DATABASE || 'PAIZHU',
  username: process.env.DM_USER || 'SYSDBA',
  password: process.env.DM_PASSWORD || 'SYSDBA',
  logging: console.log,
  pool: {
    max: 10,
    min: 0,
    acquire: 30000,
    idle: 10000
  }
})
```

### 2.3 数据类型映射

| MySQL | 达梦数据库 | 说明 |
|-------|-----------|------|
| INT | INT | 整数 |
| VARCHAR(n) | VARCHAR(n) | 变长字符串 |
| TEXT | TEXT 或 CLOB | 长文本 |
| DATETIME | DATETIME | 日期时间 |
| JSON | TEXT | JSON 存储为文本 |
| ENUM | VARCHAR | 枚举转为字符串 |
| BLOB | BLOB | 二进制数据 |

### 2.4 SQL 语法差异

#### 分页查询
```sql
-- MySQL
SELECT * FROM users LIMIT 10 OFFSET 20;

-- 达梦（方式1：使用 LIMIT）
SELECT * FROM users LIMIT 10 OFFSET 20;

-- 达梦（方式2：使用 ROWNUM）
SELECT * FROM (
  SELECT ROWNUM rn, t.* FROM users t WHERE ROWNUM <= 30
) WHERE rn > 20;
```

#### 日期格式化
```sql
-- MySQL
SELECT DATE_FORMAT(created_at, '%Y-%m-%d') FROM logs;

-- 达梦
SELECT TO_CHAR(created_at, 'YYYY-MM-DD') FROM logs;
```

#### 字符串拼接
```sql
-- MySQL
SELECT CONCAT(name, '-', id) FROM users;

-- 达梦（支持 CONCAT）
SELECT CONCAT(name, '-', id) FROM users;

-- 达梦（也支持 ||）
SELECT name || '-' || id FROM users;
```

#### 自增主键
```sql
-- MySQL
CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100)
);

-- 达梦（使用序列）
CREATE SEQUENCE seq_users_id START WITH 1 INCREMENT BY 1;

CREATE TABLE users (
  id INT DEFAULT NEXT VALUE FOR seq_users_id PRIMARY KEY,
  name VARCHAR(100)
);
```

## 三、迁移步骤

### 步骤 1：安装达梦数据库

1. 下载达梦数据库安装包（DM8）
2. 按照官方文档安装数据库
3. 创建数据库实例：`PAIZHU`
4. 创建用户：`paizhu_user`

### 步骤 2：安装 Node.js 驱动

```bash
cd backend
npm install dmdb --save
```

### 步骤 3：修改配置文件

```bash
# backend/.env
DB_TYPE=dm8
DM_HOST=localhost
DM_PORT=5236
DM_DATABASE=PAIZHU
DM_USER=paizhu_user
DM_PASSWORD=your_password
```

### 步骤 4：生成达梦数据库建表脚本

我会帮你创建一个转换工具，将现有的 MySQL 建表脚本转换为达梦数据库脚本。

### 步骤 5：迁移数据

```bash
# 1. 从 MySQL 导出数据
mysqldump -u root -p paizhu_db > mysql_data.sql

# 2. 转换 SQL 语法（需要手动调整）
# 3. 导入到达梦数据库
```

### 步骤 6：修改代码

主要修改点：
1. `backend/config/database.js` - 数据库连接配置
2. `backend/models/*.js` - 模型定义（如果有特殊类型）
3. 原生 SQL 查询（如果有）

### 步骤 7：测试验证

```bash
# 运行测试
npm test

# 手动测试所有功能
# - 用户登录
# - 日志创建
# - 附件上传
# - 报告生成
# - 数据统计
```

## 四、兼容性处理

### 4.1 JSON 字段处理

达梦数据库不直接支持 JSON 类型，需要使用 TEXT 存储：

```javascript
// Sequelize 模型定义
{
  parsed_data: {
    type: DataTypes.TEXT,  // 改为 TEXT
    get() {
      const value = this.getDataValue('parsed_data')
      return value ? JSON.parse(value) : null
    },
    set(value) {
      this.setDataValue('parsed_data', JSON.stringify(value))
    }
  }
}
```

### 4.2 ENUM 类型处理

达梦数据库不支持 ENUM，改用 VARCHAR + CHECK 约束：

```sql
-- MySQL
role ENUM('admin', 'inspector', 'leader')

-- 达梦
role VARCHAR(20) CHECK (role IN ('admin', 'inspector', 'leader'))
```

### 4.3 日期时间处理

达梦数据库的日期时间格式与 MySQL 略有不同，需要注意：

```javascript
// 使用 Sequelize 的日期类型，会自动处理
{
  created_at: {
    type: DataTypes.DATE,
    defaultValue: DataTypes.NOW
  }
}
```

## 五、性能优化建议

### 5.1 索引优化

```sql
-- 为常用查询字段创建索引
CREATE INDEX idx_logs_date ON daily_logs(log_date);
CREATE INDEX idx_attachments_month ON attachments(upload_month);
CREATE INDEX idx_users_prison ON users(prison_name);
```

### 5.2 连接池配置

```javascript
pool: {
  max: 20,        // 最大连接数
  min: 5,         // 最小连接数
  acquire: 30000, // 获取连接超时时间
  idle: 10000     // 空闲连接超时时间
}
```

### 5.3 查询优化

- 使用预编译语句
- 避免 SELECT *
- 合理使用分页
- 定期分析表统计信息

## 六、回滚方案

如果迁移失败，可以快速回滚到 MySQL：

```bash
# 1. 修改 .env 文件
DB_TYPE=mysql

# 2. 重启服务
npm run restart

# 3. 验证功能
```

保留原有 MySQL 数据库，直到达梦数据库稳定运行 1 个月后再删除。

## 七、风险评估

| 风险 | 可能性 | 影响 | 应对措施 |
|------|--------|------|----------|
| 驱动兼容性问题 | 中 | 高 | 提前测试，准备备用方案 |
| SQL 语法差异 | 高 | 中 | 详细测试，逐个调整 |
| 性能下降 | 低 | 中 | 性能测试，优化索引 |
| 数据丢失 | 低 | 高 | 完整备份，分步迁移 |
| 功能异常 | 中 | 高 | 全面测试，灰度发布 |

## 八、时间计划

| 阶段 | 任务 | 时间 | 负责人 |
|------|------|------|--------|
| 准备 | 安装达梦数据库 | 0.5天 | 运维 |
| 准备 | 安装驱动和配置 | 0.5天 | 开发 |
| 迁移 | 表结构迁移 | 1天 | 开发 |
| 迁移 | 数据迁移 | 0.5天 | 开发 |
| 开发 | SQL 语法调整 | 1天 | 开发 |
| 测试 | 功能测试 | 1天 | 测试 |
| 部署 | 生产环境部署 | 0.5天 | 运维 |
| **总计** | - | **5天** | - |

## 九、下一步行动

1. ✅ **已完成**：创建迁移需求文档
2. ⏭️ **下一步**：安装达梦数据库并测试连接
3. ⏭️ **然后**：创建表结构转换脚本
4. ⏭️ **最后**：执行迁移并测试

## 十、需要决策的问题

1. **达梦数据库版本**：建议使用 DM8（最新稳定版）
2. **部署方式**：单机版还是集群版？
3. **迁移时间窗口**：建议选择业务低峰期（周末）
4. **灰度发布**：是否先在测试环境验证 1 周？

---

**建议**：先在测试环境完整走一遍迁移流程，确保没有问题后再迁移生产环境。
