# 附件归档月份修复说明

## 问题描述
用户上传的附件没有正确归档到对应的月份。例如：
- 在 2 月份补录 1 月份的日志时，附件被归档到 2 月而不是 1 月
- 导致月度归档下载时缺少部分附件

## 根本原因
前端上传附件时，**没有传递 `upload_month` 参数**。后端虽然有默认值（使用当前月份），但这会导致补录历史数据时归档月份错误。

## 修复方案
在所有附件上传的地方，添加 `upload_month` 参数，**根据日志/事件的实际日期**来设置归档月份。

### 修复的文件和位置

#### 1. `front/src/views/DailyCheck.vue`

**修复内容：**
- ✅ 日检察附件上传（`uploadAttachments` 函数）
- ✅ 周检察附件上传（`uploadWeeklyAttachments` 函数）
  - 医院检察附件
  - 外伤检察附件
  - 违禁品照片
- ✅ 月检察附件上传（`uploadMonthlyAttachments` 函数）

**修复代码：**
```javascript
// 添加这一行
formData.append('upload_month', logDate.slice(0, 7))  // 根据日志日期设置归档月份（YYYY-MM）
```

#### 2. `front/src/views/ImmediateCheck.vue`

**修复内容：**
- ✅ 即时检察事件附件上传

**修复代码：**
```javascript
const eventDate = eventForm.event_date || new Date().toISOString().split('T')[0]
formData.append('log_date', eventDate)
formData.append('upload_month', eventDate.slice(0, 7))  // 根据事件日期设置归档月份
```

#### 3. `front/src/views/MaterialUpload.vue`

**状态：** ✅ 已正确实现（无需修复）
- 该页面已经正确传递了 `upload_month` 参数

## 归档逻辑说明

### 后端处理（`backend/routes/attachments.js`）
```javascript
// 使用前端传递的 upload_month，如果没有则使用当前月份
const uploadMonth = upload_month || new Date().toISOString().slice(0, 7)
```

### 归档规则
1. **优先使用日志/事件的实际日期**：`logDate.slice(0, 7)` → `"2026-01"`
2. **格式**：`YYYY-MM`（如 `2026-01`、`2026-02`）
3. **存储字段**：`attachments.upload_month`

### 月度归档查询
归档下载时，后端会查询：
```sql
SELECT * FROM attachments 
WHERE upload_month = '2026-01' 
  AND user_id = ?
```

## 测试验证

### 测试场景
1. **当天录入当天数据**：附件应归档到当月
2. **补录历史数据**：附件应归档到历史数据所在月份
3. **跨月补录**：在 2 月补录 1 月数据，附件应归档到 1 月

### 验证方法
1. 上传附件后，检查数据库 `attachments` 表的 `upload_month` 字段
2. 下载月度归档，检查附件是否完整

## 影响范围

### 已修复的附件类型
- ✅ 日检察日志附件
- ✅ 监控抽查异常附件（如果有上传功能）
- ✅ 周检察-医院检察附件
- ✅ 周检察-外伤检察附件
- ✅ 周检察-违禁品照片
- ✅ 周检察-谈话笔录（如果有上传功能）
- ✅ 月检察-惩罚证据材料
- ✅ 即时检察事件附件

### 历史数据处理
对于已经上传但 `upload_month` 错误的历史附件，可以运行以下 SQL 修复：

```sql
-- 根据文件名中的日期修复 upload_month
UPDATE attachments 
SET upload_month = CONCAT(
  SUBSTRING(file_name, 1, 4), '-', 
  SUBSTRING(file_name, 5, 2)
)
WHERE file_name REGEXP '^[0-9]{8}_'
  AND (upload_month IS NULL OR upload_month != CONCAT(
    SUBSTRING(file_name, 1, 4), '-', 
    SUBSTRING(file_name, 5, 2)
  ));

-- 检查修复结果
SELECT 
  id, 
  file_name, 
  upload_month,
  CONCAT(SUBSTRING(file_name, 1, 4), '-', SUBSTRING(file_name, 5, 2)) as expected_month
FROM attachments 
WHERE file_name REGEXP '^[0-9]{8}_'
LIMIT 20;
```

## 注意事项
1. 所有附件上传都必须传递 `log_date` 或 `event_date` 参数
2. `upload_month` 格式必须是 `YYYY-MM`
3. 补录历史数据时，确保日期选择器选择的是正确的历史日期
