# 附件问题诊断和修复

## 问题描述

用户反馈：上传了多个附件，但是在日志详情中只显示了3个附件。

## 诊断过程

### 1. 数据库检查

通过 `check_attachments_raw.js` 直接查询数据库，确认 2026-02-05 确实只有3个附件：

```
ID: 45 - 微信图片_20250809224718.jpg (weekly_contraband)
ID: 44 - test.docx (weekly_injury)
ID: 43 - OT20230221150501915-2879169349.jpg (weekly_hospital)
```

### 2. 代码审查

检查了所有上传组件的代码，发现以下问题：

#### 问题1：周检察谈话笔录没有上传逻辑 ❌

**位置**：`front/src/views/DailyCheck.vue` - `uploadWeeklyAttachments()` 函数

**问题**：
- 周检察有4个上传组件：医院检察、外伤检察、谈话笔录、违禁品照片
- 但是 `uploadWeeklyAttachments()` 函数只上传了前3个，**缺少谈话笔录的上传逻辑**

**影响**：
- 用户上传的谈话笔录文件不会被保存到数据库
- 前端显示已选择文件，但提交后文件丢失

#### 问题2：监控异常记录附件没有上传逻辑 ❌

**位置**：`front/src/views/DailyCheck.vue` - `addAnomaly()` 函数

**问题**：
- 监控异常记录对话框有附件上传组件
- 但是 `addAnomaly()` 函数只保存了文本数据，**没有上传附件的逻辑**

**影响**：
- 用户选择的附件不会被上传
- 异常记录中无法保存附件

#### 问题3：周检察表单重置不完整 ⚠️

**位置**：`front/src/views/DailyCheck.vue` - `resetWeeklyForm()` 函数

**问题**：
- 重置表单时只清空了表单数据和 localStorage 草稿
- **没有清空附件列表和上传组件**

**影响**：
- 提交后再次打开周检察对话框，之前的附件还在
- 用户可能误以为附件还需要上传

## 修复方案

### 修复1：添加谈话笔录上传逻辑 ✅

在 `uploadWeeklyAttachments()` 函数中添加谈话笔录的上传：

```javascript
// 谈话笔录
if (weeklyTalkFiles.value.length > 0) {
  const formData = new FormData()
  weeklyTalkFiles.value.forEach(fileItem => {
    formData.append('files', fileItem.raw)
  })
  formData.append('category', 'weekly_talk')
  formData.append('related_log_id', recordId)
  formData.append('related_log_type', 'weekly')
  formData.append('log_date', logDate)
  formData.append('upload_month', uploadMonth)
  
  uploadTasks.push(
    fetch(`${API_BASE}/api/attachments/upload`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` },
      body: formData
    }).then(response => {
      if (!response.ok) {
        throw new Error('谈话笔录上传失败')
      }
      return response.json()
    }).then(result => {
      console.log('✅ 谈话笔录上传成功:', result)
    })
  )
}
```

### 修复2：完善周检察表单重置 ✅

在 `resetWeeklyForm()` 函数中添加清空附件的逻辑：

```javascript
// 清空附件列表
weeklyHospitalFiles.value = []
weeklyInjuryFiles.value = []
weeklyTalkFiles.value = []
weeklyContrabandFiles.value = []

// 清空上传组件
nextTick(() => {
  weeklyHospitalUploadRef.value?.clearFiles()
  weeklyInjuryUploadRef.value?.clearFiles()
  weeklyTalkUploadRef.value?.clearFiles()
  weeklyContrabandUploadRef.value?.clearFiles()
})
```

### 修复3：监控异常记录附件上传（待实现）

**建议方案**：
1. 给监控异常记录的上传组件添加 ref
2. 在 `addAnomaly()` 函数中上传附件
3. 将附件信息保存到异常记录中

**注意**：由于监控异常记录是嵌套在日志中的，需要考虑：
- 附件的 `related_log_id` 应该是日志ID还是异常记录ID？
- 附件的 `category` 应该是什么？（建议：`monitoring_abnormal`）
- 是否需要在提交日志时一起上传？

## 测试建议

### 1. 测试谈话笔录上传

1. 打开日检察页面
2. 点击"填写周检察"
3. 在"罪犯谈话记录"中勾选"是否上传谈话笔录"
4. 上传一个 PDF 或 Word 文件
5. 填写其他必填项
6. 点击"同步到日志"
7. 提交日志
8. 查看日志详情，确认谈话笔录已上传

### 2. 测试表单重置

1. 打开日检察页面
2. 点击"填写周检察"
3. 上传一些附件
4. 点击"同步到日志"
5. 再次点击"填写周检察"
6. 确认附件列表已清空

### 3. 测试附件归档

1. 上传附件时，确认 `upload_month` 字段正确设置为日志日期的年月（YYYY-MM）
2. 在工作概览页面查看附件统计
3. 在月度归档中查看附件列表

## 附件上传组件清单

### 日检察（已删除）
- ~~日志附件上传~~ - 已删除

### 周检察（4个）
1. ✅ 医院检察附件 - `weekly_hospital`
2. ✅ 外伤检察附件 - `weekly_injury`
3. ✅ 谈话笔录 - `weekly_talk` **（已修复）**
4. ✅ 违禁品照片 - `weekly_contraband`

### 月检察（1个）
1. ✅ 惩罚证据材料 - `monthly_punishment`

### 即时检察（1个）
1. ✅ 即时检察附件 - `immediate_check`

### 监控异常记录（待修复）
1. ❌ 监控异常附件 - 无上传逻辑

## 总结

主要问题是**周检察的谈话笔录没有上传逻辑**，导致用户上传的文件丢失。已经修复了这个问题，并完善了表单重置逻辑。

监控异常记录的附件上传功能还需要进一步实现，建议根据实际需求决定是否添加。
