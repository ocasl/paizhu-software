# 附件问题排查指南

## 问题描述
用户反馈"相关材料附件"没有被收集到月度归档中。

## 可能的原因

### 1. 附件上传失败
- 网络问题导致上传失败
- 文件大小超过限制（50MB）
- 文件类型不支持

### 2. 附件关联信息缺失
- `related_log_id` 未设置
- `related_log_type` 未设置
- `upload_month` 未设置

### 3. 归档查询逻辑问题
- 查询条件不正确
- 时间范围不匹配

## 排查步骤

### 步骤1：检查附件数据完整性

运行诊断脚本：
```bash
cd backend
node check_attachments.js
```

这个脚本会检查：
- ✅ 总附件数量
- ✅ 按分类统计
- ✅ 关联状态（已关联/未关联）
- ✅ upload_month 字段设置情况
- ✅ 按月份统计
- ✅ 最近的日检察附件详情
- ✅ 孤儿附件（关联的日志不存在）
- ✅ 文件是否实际存在

### 步骤2：检查数据库

```sql
-- 查看最近上传的日检察附件
SELECT 
    id,
    original_name,
    category,
    related_log_id,
    related_log_type,
    upload_month,
    created_at
FROM attachments
WHERE category = 'daily_log'
ORDER BY created_at DESC
LIMIT 20;

-- 检查未关联的附件
SELECT 
    id,
    original_name,
    category,
    upload_month,
    created_at
FROM attachments
WHERE related_log_id IS NULL
  AND category = 'daily_log'
ORDER BY created_at DESC;

-- 检查某个月的附件统计
SELECT 
    category,
    COUNT(*) as count
FROM attachments
WHERE upload_month = '2026-02'
GROUP BY category;
```

### 步骤3：检查前端上传流程

打开浏览器开发者工具（F12），查看 Network 标签：

1. 上传附件时，检查 `/api/attachments/upload` 请求
2. 查看请求参数：
   - `files`: 文件列表
   - `category`: 应该是 `daily_log`
   - `related_log_id`: 日志ID
   - `related_log_type`: 应该是 `daily`
   - `log_date`: 日志日期
   - `upload_month`: 归档月份（YYYY-MM）

3. 查看响应：
   - 状态码应该是 200
   - `success: true`
   - `data`: 附件列表

### 步骤4：检查归档下载

查看归档下载时的查询逻辑：

```javascript
// backend/routes/archive.js
// 查找该日志的附件(通过related_log_id关联)
const logAttachments = await Attachment.findAll({
    where: {
        related_log_type: 'daily',
        related_log_id: log.id
    }
})
```

确认：
- ✅ 查询条件正确
- ✅ 日志ID匹配
- ✅ 附件文件存在

## 常见问题和解决方案

### 问题1：附件上传成功但未关联到日志

**原因**：日志创建失败或返回的日志ID不正确

**解决方案**：
```javascript
// 检查 submitLog 函数
const result = await response.json()
if (response.ok && result.success) {
  // 确保 result.data.id 存在
  console.log('日志ID:', result.data.id)
  await uploadAttachments(result.data.id, logDate)
}
```

### 问题2：upload_month 未设置

**原因**：前端上传时没有传递 `upload_month` 参数

**解决方案**：已修复，现在所有上传都会设置 `upload_month`

### 问题3：附件文件不存在

**原因**：
- 文件上传到错误的目录
- 文件被误删除
- 路径配置错误

**解决方案**：
```bash
# 检查上传目录
ls -la backend/uploads/attachments/

# 检查文件权限
chmod 755 backend/uploads/attachments/
```

### 问题4：归档下载时附件缺失

**原因**：
- 附件的 `related_log_id` 与日志ID不匹配
- 附件的 `related_log_type` 不是 'daily'
- 文件路径错误

**解决方案**：
```sql
-- 修复关联关系（如果日志ID正确但关联错误）
UPDATE attachments 
SET related_log_type = 'daily'
WHERE category = 'daily_log'
  AND related_log_id IS NOT NULL
  AND (related_log_type IS NULL OR related_log_type = '');
```

## 修复历史数据

### 修复未设置 upload_month 的附件

```sql
-- 根据文件名中的日期修复
UPDATE attachments 
SET upload_month = CONCAT(
  SUBSTRING(file_name, 1, 4), '-', 
  SUBSTRING(file_name, 5, 2)
)
WHERE file_name REGEXP '^[0-9]{8}_'
  AND (upload_month IS NULL OR upload_month = '');

-- 根据创建时间修复
UPDATE attachments 
SET upload_month = DATE_FORMAT(created_at, '%Y-%m')
WHERE upload_month IS NULL OR upload_month = '';
```

### 修复未关联的日检察附件

```sql
-- 根据日期和用户匹配日志
UPDATE attachments a
INNER JOIN daily_logs dl ON 
  DATE(a.created_at) = dl.log_date 
  AND a.user_id = dl.user_id
SET 
  a.related_log_id = dl.id,
  a.related_log_type = 'daily'
WHERE a.category = 'daily_log'
  AND a.related_log_id IS NULL;
```

## 预防措施

### 1. 前端验证
- ✅ 上传前检查文件大小和类型
- ✅ 上传后检查响应状态
- ✅ 显示上传进度和结果

### 2. 后端日志
- ✅ 记录所有上传请求
- ✅ 记录失败原因
- ✅ 定期检查孤儿附件

### 3. 定期检查
```bash
# 每周运行一次诊断脚本
cd backend
node check_attachments.js > attachments_report_$(date +%Y%m%d).txt
```

## 用户操作指南

### 提交日志时的注意事项

1. **上传附件**：
   - 点击"选择文件"按钮
   - 选择要上传的文件（支持多选）
   - 确认文件列表中显示了所有文件

2. **提交日志**：
   - 点击"提交日志"按钮
   - 等待提示"日志和附件提交成功"
   - 如果提示"附件上传失败"，请重新上传

3. **验证附件**：
   - 切换到"历史记录"视图
   - 找到刚提交的日志
   - 点击"查看详情"
   - 检查"相关材料附件"部分是否显示了附件

### 如果附件丢失

1. 联系管理员运行诊断脚本
2. 提供日志日期和附件文件名
3. 管理员会检查数据库并修复关联关系

## 已修复的问题

### ✅ 提交后表单清空
- 保留派驻单位和派驻人员
- 清空所有业务数据
- 日期自动设置为明天
- 清空附件列表

### ✅ upload_month 设置
- 所有附件上传都会设置 `upload_month`
- 根据日志/事件日期设置，而不是上传时间

### ✅ 附件列表清空
- 提交后调用 `uploadRef.value.clearFiles()`
- 清空 el-upload 组件的内部状态
