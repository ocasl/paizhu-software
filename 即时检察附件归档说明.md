# 即时检察附件归档说明

## 当前状态

### ✅ 已完成的修复

1. **前端上传时设置 `upload_month`**（`front/src/views/ImmediateCheck.vue`）
   ```javascript
   const eventDate = eventForm.event_date || new Date().toISOString().split('T')[0]
   formData.append('log_date', eventDate)
   formData.append('upload_month', eventDate.slice(0, 7))  // 根据事件日期设置归档月份
   ```

2. **归档下载时包含即时检察附件**（`backend/routes/archive.js`）
   - 即时检察事件和附件会被打包到 `04-及时检察/` 目录
   - 附件按 `日期_类型_附件/` 组织
   - 附件通过 `attachment_ids` 字段关联

### 即时检察附件的特殊性

与日检察、周检察、月检察不同，即时检察的附件关联方式是：
- **其他检察**：使用 `related_log_id` + `related_log_type` 关联
- **即时检察**：使用 `attachment_ids` JSON 数组存储附件ID列表

### 数据流程

```
1. 用户上传附件
   ↓
2. 前端调用 /api/attachments/upload
   - category: 'immediate_event'
   - log_date: 事件日期
   - upload_month: 事件日期的年月（YYYY-MM）
   ↓
3. 后端创建附件记录
   - 附件表中记录 upload_month
   - 返回附件ID列表
   ↓
4. 前端创建即时检察事件
   - 调用 /api/immediate-events
   - 传递 attachmentIds 数组
   ↓
5. 后端创建事件记录
   - immediate_events 表中存储 attachment_ids (JSON)
   ↓
6. 月度归档下载
   - 查询该月的即时检察事件
   - 根据 attachment_ids 查找附件
   - 打包到 04-及时检察/ 目录
```

### 归档目录结构

```
归档包/
├── 01-日检察/
│   ├── 2026-01-15_日检察日志.docx
│   └── 2026-01-15_附件/
│       └── xxx.jpg
├── 02-周检察/
│   └── 2026-01-20_附件/
│       └── xxx.jpg
├── 03-月检察/
│   └── 2026-01_附件/
│       └── xxx.pdf
├── 04-及时检察/
│   ├── 2026-01-18_脱逃_某某脱逃事件.docx
│   └── 2026-01-18_脱逃_附件/
│       ├── 现场照片1.jpg
│       └── 现场照片2.jpg
├── 05-其他材料/
│   └── 未关联的附件.pdf
└── 报告/
    ├── 月度工作报告.docx
    └── 事项清单.docx
```

## 验证方法

### 1. 检查附件的 upload_month 字段

```sql
-- 查看即时检察附件的归档月份
SELECT 
    id,
    category,
    original_name,
    upload_month,
    created_at
FROM attachments
WHERE category = 'immediate_event'
ORDER BY created_at DESC
LIMIT 20;
```

### 2. 检查即时检察事件的附件关联

```sql
-- 查看即时检察事件及其附件
SELECT 
    ie.id,
    ie.event_date,
    ie.event_type,
    ie.title,
    ie.attachment_ids,
    DATE_FORMAT(ie.event_date, '%Y-%m') as event_month
FROM immediate_events ie
WHERE ie.event_date >= '2026-01-01'
ORDER BY ie.event_date DESC;
```

### 3. 测试归档下载

1. 创建一个即时检察事件并上传附件
2. 下载该月的归档包
3. 检查 `04-及时检察/` 目录中是否包含：
   - 事件文档（`.docx`）
   - 附件文件夹（`日期_类型_附件/`）
   - 附件文件

## 潜在问题和解决方案

### 问题1：历史数据的 upload_month 可能为空

**解决方案：** 运行修复SQL

```sql
-- 方案1：根据事件日期修复即时检察附件的 upload_month
UPDATE attachments a
INNER JOIN immediate_events ie ON JSON_CONTAINS(ie.attachment_ids, CAST(a.id AS JSON))
SET a.upload_month = DATE_FORMAT(ie.event_date, '%Y-%m')
WHERE a.category = 'immediate_event'
  AND (a.upload_month IS NULL OR a.upload_month = '');

-- 方案2：根据文件名中的日期修复（如果文件名包含日期）
UPDATE attachments 
SET upload_month = CONCAT(
  SUBSTRING(file_name, 1, 4), '-', 
  SUBSTRING(file_name, 5, 2)
)
WHERE category = 'immediate_event'
  AND file_name REGEXP '^[0-9]{8}_'
  AND (upload_month IS NULL OR upload_month = '');

-- 方案3：根据创建时间修复（最后的兜底方案）
UPDATE attachments 
SET upload_month = DATE_FORMAT(created_at, '%Y-%m')
WHERE category = 'immediate_event'
  AND (upload_month IS NULL OR upload_month = '');
```

### 问题2：附件未关联到事件

如果附件上传了但事件创建失败，附件会变成"孤儿"附件。

**解决方案：**
- 这些附件会被归档到 `05-其他材料/` 目录
- 可以手动删除或重新关联

### 问题3：跨月补录

在2月份补录1月份的即时检察事件时，确保：
1. 事件日期选择1月份的日期
2. 附件会自动归档到1月份（因为 `upload_month` 根据事件日期设置）

## 总结

✅ **即时检察附件已正确支持月度归档**

- 上传时自动设置 `upload_month`
- 归档下载时正确打包
- 支持跨月补录
- 历史数据可通过SQL修复
